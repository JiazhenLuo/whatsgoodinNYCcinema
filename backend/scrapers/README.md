# 电影爬虫系统

这个目录包含用于爬取各个电影院放映信息的爬虫，目前支持 Metrograph 等影院。

## 日志系统

爬虫使用了统一的日志系统，具有以下特点：

1. **双重输出**：同时输出到控制台和文件，方便实时查看和问题排查
2. **日志轮转**：使用 `RotatingFileHandler` 实现日志文件大小限制和自动轮转，避免日志文件过大
3. **性能监控**：记录函数执行时间和内存使用情况，方便性能分析和优化
4. **详细的错误信息**：记录完整的堆栈跟踪，方便调试问题
5. **自动清理**：定期清理旧日志文件，避免磁盘空间占用过大

## 最近优化

### 1. 统一日志系统
- 使用了标准化的日志格式和级别
- 添加了表情符号，提高日志可读性
- 移除了混合使用的 `print` 和 `logger` 调用

### 2. 性能优化
- 添加了执行时间记录装饰器，监控各函数耗时
- 添加了内存使用监控，避免内存泄漏
- 优化了数据结构，使用集合去重计算日期总数

### 3. 错误处理
- 添加了全局异步重试装饰器，自动处理临时性错误
- 添加了详细的错误日志，包括堆栈跟踪信息
- 使用 finally 块确保资源正确释放

### 4. 代码结构
- 提取了通用的页面请求函数，减少代码重复
- 使用装饰器封装了常见的横切关注点

## 爬虫列表

### Metrograph 爬虫

```bash
python backend/scrapers/metrograph.py
```

爬取 [Metrograph 影院](https://metrograph.com/) 的电影放映信息。特点：
- 支持从日历页面自动发现有效日期
- 自动提取电影详情，包括导演、年份、语言等
- 识别特殊放映场次，如 Q&A 和介绍场

## 使用方法

运行单个爬虫：

```bash
python backend/scrapers/<爬虫名>.py
```

查看生成的数据文件：

```
backend/database/<爬虫名>_movies.json
```

## 日志文件位置

日志文件位于：

```
backend/logs/<爬虫名>_YYYYMMDD_HHMMSS.log
```

## 依赖项

爬虫需要以下依赖：

```bash
pip install playwright bs4 psutil
```

初始化 Playwright:

```bash
playwright install
``` 